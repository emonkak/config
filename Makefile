# Makefile to update config.
# Generic  #{{{1

all: update
.PHONY: \
  all \
  update




# Group definitions  #{{{1

ALL_GROUPS=\
  DOTS \
  LINUX \
  OPERA \
  PORTAGE \
  VIM

GROUP_DOTS_FILES=\
  .Xmodmap \
  .Xresources \
  .conky.lua \
  .conkyrc \
  .fonts.conf \
  .gitconfig \
  .mfiler \
  .screenrc \
  .tmux.conf \
  .vimrc \
  .xinitrc \
  .xmobarrc \
  .xmonad/xmonad.hs \
  .zprofile \
  .zshrc
GROUP_DOTS_RULE=$(patsubst .%, $(HOME)/.%, $(1))

GROUP_LINUX_FILES=\
  linux/.config
GROUP_LINUX_RULE=$(patsubst linux/%, /usr/src/linux/%, $(1))

GROUP_OPERA_FILES=\
  .opera/keyboard/my-keyboard.ini \
  .opera/menu/my-menu.ini \
  .opera/mouse/my-mouse.ini \
  .opera/search.ini \
  .opera/styles/google.css \
  .opera/styles/ldr.css \
  .opera/styles/user.css
GROUP_OPERA_RULE=$(patsubst .opera/%, $(HOME)/.opera/%, $(1))

GROUP_PORTAGE_FILES=\
  portage/package.keywords \
  portage/package.mask \
  portage/package.unmask \
  portage/package.use \
  portage/profile/package.provided
GROUP_PORTAGE_RULE=$(patsubst portage/%, /etc/portage/%, $(1))

GROUP_VIM_FILES=\
  .vim/colors/basic256.vim
GROUP_VIM_RULE=$(patsubst .vim/%, $(HOME)/.vim/%, $(1))




# update  #{{{1
# Rules for `update' are generated by eval.

RemoveCurrentDirectory=$(filter-out ./,$(1))
RemoveDuplicates=$(sort $(1))
CallRule=$(call RemoveCurrentDirectory,$(call GROUP_$(1)_RULE,$(2)))

define GenerateRulesToUpdateFile  # (src, dest)
update: $(2)
$(2): $(1)
	@cp '$$<' '$$@'
	@echo 'update:' '$$@'

endef

define GenerateRulesToUpdateDirectory  # (dest)
update: $(1)
$(1):
	@mkdir -p '$$@'

endef

define GenerateRulesFromGroups  # (groups = (group_name*))
$(foreach directory, \
  $(call RemoveDuplicates, \
    $(foreach group, \
      $(1), \
      $(dir $(GROUP_$(group)_FILES)))), \
  $(call GenerateRulesToUpdateDirectory,$(directory)))
$(foreach group, \
  $(1), \
  $(foreach file, \
    $(GROUP_$(group)_FILES), \
    $(call GenerateRulesToUpdateFile,$(call CallRule,$(group),$(file)),$(file))))
endef

$(eval $(call GenerateRulesFromGroups,$(ALL_GROUPS)))




# __END__  #{{{1
# vim: foldmethod=marker
